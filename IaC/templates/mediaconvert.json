{
  "MediaConvertEndPoint": {
    "Type": "AWS::CloudFormation::CustomResource",
    "Properties": {
      "ServiceToken": {
        "Fn::GetAtt": [
          "CustomResource8CDCD7A7",
          "Arn"
        ]
      },
      "Resource": "EndPoint"
    },
    "UpdateReplacePolicy": "Delete",
    "DeletionPolicy": "Delete",
    "Metadata": {
      "aws:cdk:path": "VideoOnDemand/MediaConvertEndPoint/Default"
    }
  },
  "MediaConvertTemplates": {
    "Type": "AWS::CloudFormation::CustomResource",
    "Properties": {
      "ServiceToken": {
        "Fn::GetAtt": [
          "CustomResource8CDCD7A7",
          "Arn"
        ]
      },
      "Resource": "MediaConvertTemplates",
      "StackName": {
        "Ref": "AWS::StackName"
      },
      "EndPoint": {
        "Fn::GetAtt": [
          "MediaConvertEndPoint",
          "EndpointUrl"
        ]
      },
      "EnableMediaPackage": {
        "Fn::If": [
          "EnableMediaPackageCondition",
          "true",
          "false"
        ]
      },
      "EnableNewTemplates": true
    },
    "UpdateReplacePolicy": "Delete",
    "DeletionPolicy": "Delete",
    "Metadata": {
      "aws:cdk:path": "VideoOnDemand/MediaConvertTemplates/Default"
    }
  },
  "MediaConvertRole": {
    "Type": "AWS::IAM::Role",
    "Properties": {
      "AssumeRolePolicyDocument": {
        "Statement": [
          {
            "Action": "sts:AssumeRole",
            "Effect": "Allow",
            "Principal": {
              "Service": "mediaconvert.amazonaws.com"
            }
          }
        ],
        "Version": "2012-10-17"
      },
      "Tags": [
        {
          "Key": "SolutionId",
          "Value": "SO0021"
        }
      ]
    },
    "Metadata": {
      "cfn_nag": {
        "rules_to_suppress": [
          {
            "id": "W11",
            "reason": "/* required to get/put objects to S3"
          }
        ]
      }
    }
  },
  "MediaConvertPolicy": {
    "Type": "AWS::IAM::Policy",
    "Properties": {
      "PolicyDocument": {
        "Statement": [
          {
            "Action": [
              "s3:GetObject",
              "s3:PutObject"
            ],
            "Effect": "Allow",
            "Resource": [
              {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Fn::GetAtt": [
                        "Source71E471F1",
                        "Arn"
                      ]
                    },
                    "/*"
                  ]
                ]
              },
              {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Fn::GetAtt": [
                        "Destination920A3C57",
                        "Arn"
                      ]
                    },
                    "/*"
                  ]
                ]
              }
            ]
          },
          {
            "Action": "execute-api:Invoke",
            "Effect": "Allow",
            "Resource": {
              "Fn::Join": [
                "",
                [
                  "arn:",
                  {
                    "Ref": "AWS::Partition"
                  },
                  ":execute-api:",
                  {
                    "Ref": "AWS::Region"
                  },
                  ":",
                  {
                    "Ref": "AWS::AccountId"
                  },
                  ":*"
                ]
              ]
            }
          }
        ],
        "Version": "2012-10-17"
      },
      "PolicyName": {
        "Fn::Join": [
          "",
          [
            {
              "Ref": "AWS::StackName"
            },
            "-mediatranscode-policy"
          ]
        ]
      },
      "Roles": [
        {
          "Ref": "MediaConvertRole031A64A9"
        }
      ]
    },
    "Metadata": {
      "aws:cdk:path": "VideoOnDemand/MediaConvertPolicy/Resource",
      "cdk_nag": {
        "rules_to_suppress": [
          {
            "reason": "/* required to get/put objects to S3",
            "id": "AwsSolutions-IAM5"
          }
        ]
      }
    }
  },
  "TemplateConfiguration": {
    "Description": "MediaConvert job templates configuration for Video on Demand solution",
    "TemplateTypes": {
      "QVBR": {
        "Description": "Quality-defined Variable Bit-Rate templates for standard video processing",
        "Templates": [
          {
            "Name": "{StackName}_Ott_universal_Avc_Aac_16x9_qvbr_no_preset",
            "Description": "Universal CMAF adaptive bitrate template for iOS and Android devices - QVBR",
            "Category": "VOD",
            "Format": "CMAF",
            "Platform": "Universal",
            "DeviceSupport": "iOS-Android",
            "QualityMode": "QVBR",
            "Resolutions": ["2160p", "1080p", "720p", "540p", "360p"]
          }
        ]
      },
      "MVOD": {
        "Description": "MediaPackage VOD templates for advanced video delivery with DRM support",
        "Templates": [
          {
            "Name": "{StackName}_Ott_universal_Avc_Aac_16x9_mvod_no_preset",
            "Description": "Universal CMAF adaptive bitrate template for MediaPackage VOD - MVOD",
            "Category": "VOD",
            "Format": "CMAF",
            "Platform": "Universal",
            "DeviceSupport": "iOS-Android",
            "QualityMode": "MVOD",
            "Resolutions": ["2160p", "1080p", "720p", "540p", "360p"]
          }
        ]
      }
    },
    "TemplateCreation": {
      "Method": "CustomResource",
      "CustomResourceFunction": "CustomResource8CDCD7A7",
      "TemplateSource": "universal_cmaf_template.json",
      "Parameters": {
        "StackName": "AWS::StackName",
        "EnableMediaPackage": "EnableMediaPackageCondition",
        "EndPoint": "MediaConvertEndPoint.EndpointUrl"
      }
    },
    "TemplateFeatures": {
      "AdaptiveBitrate": true,
      "CMAFSupport": true,
      "HLSCompatible": true,
      "DASHCompatible": true,
      "iOSSupport": true,
      "AndroidSupport": true,
      "QualityLevels": {
        "2160p": {
          "MaxBitrate": "15000Kbps",
          "QvbrQualityLevel": 9
        },
        "1080p": {
          "MaxBitrate": "8500Kbps",
          "QvbrQualityLevel": 8
        },
        "720p": {
          "MaxBitrate": "6000Kbps",
          "QvbrQualityLevel": 8
        },
        "540p": {
          "MaxBitrate": "3500Kbps",
          "QvbrQualityLevel": 7
        },
        "360p": {
          "MaxBitrate": "1500Kbps",
          "QvbrQualityLevel": 7
        }
      }
    },
    "OutputFormats": {
      "CMAF": {
        "Description": "Common Media Application Format - Universal compatibility",
        "Manifests": ["HLS", "DASH"],
        "SegmentLength": 6,
        "FragmentLength": 6
      },
      "HLS": {
        "Description": "HTTP Live Streaming - Apple devices",
        "Manifest": "index.m3u8",
        "SegmentControl": "SEGMENTED_FILES"
      },
      "DASH": {
        "Description": "Dynamic Adaptive Streaming - Android/Web",
        "Manifest": "index.mpd",
        "SegmentControl": "SEGMENTED_FILES"
      }
    },
    "CodecSettings": {
      "Video": {
        "Codec": "H_264",
        "Profile": "HIGH",
        "Level": "LEVEL_4_1",
        "RateControlMode": "QVBR",
        "QualityTuningLevel": "MULTI_PASS_HQ",
        "MaxBitrate": "Variable by resolution",
        "MaxAverageBitrate": "Variable by resolution"
      },
      "Audio": {
        "Codec": "AAC",
        "SampleRate": 48000,
        "Bitrate": 128000,
        "Channels": 2
      }
    },
    "TemplateUsage": {
      "WorkflowIntegration": "Step Functions Process Workflow",
      "LambdaFunction": "EncodeLambdaDADCB2BB",
      "TemplateSelection": "Dynamic based on MediaPackage setting",
      "FallbackLogic": "QVBR to MVOD or vice versa if template not found"
    },
    "Customization": {
      "TemplateFile": "IaC/templates/universal_cmaf_template.json",
      "CreationScript": "IaC/create-mediaconvert-templates.ps1",
      "Parameters": {
        "StackName": "Required - Used for template naming",
        "EnableMediaPackage": "Required - Determines template type (QVBR/MVOD)",
        "Region": "Required - AWS region for MediaConvert endpoint"
      }
    }
  }
}
